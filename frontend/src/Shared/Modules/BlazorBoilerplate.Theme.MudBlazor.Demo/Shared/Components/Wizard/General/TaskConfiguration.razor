@inject IStringLocalizer<Global> L
@inject IApiClient apiClient
@inject IViewNotifier viewNotifier
@using Newtonsoft.Json

<style>
.strategy-description-tooltip {
    max-width: 330px;
}
</style>

<MudStack>
    @switch (Dataset.Dataset.Type.ID)
    {
        case ":time_series_longitudinal":
        case ":text":
        case ":tabular":
        case ":time_series":
            <MudTimeline TimelineOrientation="@TimelineOrientation.Horizontal" TimelinePosition="@TimelinePosition.Bottom">
                <MudTimelineItem>
                    <MudText Align="Align.Center" Typo="Typo.body2">@L["Dataset preparation"]</MudText>
                </MudTimelineItem>
                <MudTimelineItem Color="Color.Secondary">
                    <MudText Align="Align.Center" Typo="Typo.body2">@L["Configuration"]</MudText>
                </MudTimelineItem>
            </MudTimeline>
            break;
        case ":image":
            <MudTimeline TimelineOrientation="@TimelineOrientation.Horizontal" TimelinePosition="@TimelinePosition.Bottom">
                <MudTimelineItem Color="Color.Secondary">
                    <MudText Align="Align.Center" Typo="Typo.body2">@L["Configuration"]</MudText>
                </MudTimelineItem>
            </MudTimeline>
            break;
    }

    @if (_compatibletasks != null)
    {
        <MudSelect Label="@L["ML task"]" T="string" ValueChanged="@OnMlTaskSelectionChanged">
            @foreach (var task in _compatibletasks.Tasks)
            {
                <MudSelectItem Value="@task.ID">@L[task.Properties.ContainsKey("skos:prefLabel") ? task.Properties["skos:prefLabel"] : ""]</MudSelectItem>
            }
        </MudSelect>
    }
    else
    {
        <DataLoaderSpinner />
    }

    @if (((Dataset.Dataset.Type.ID == ":tabular") || (Dataset.Dataset.Type.ID == ":text") || (Dataset.Dataset.Type.ID == ":time_series")) || (Dataset.Dataset.Type.ID == ":time_series_longitudinal") && (!string.IsNullOrEmpty(StartAutoMlRequest.Configuration.Task)))

    {
        <MudSelect Label="@L["Target"]" T="string" @bind-SelectedValues="SelectedTargets" MultiSelection="true">
            @if (_columnNames != null)
            {
                @foreach (var column in _columnNames)
                {
                    <MudSelectItem Value="@column">@column</MudSelectItem>
                }
            }
        </MudSelect>
    }
    <MudNumericField ValueChanged="@OnRuntimeValueChanged" T="int" Label="@L["Runtime"]" Variant="Variant.Text" Min="3" Max="180" Value="@StartAutoMlRequest.Configuration.RuntimeLimit" />

    <MudExpansionPanels>
        <MudExpansionPanel Text="@L["Details"]">
            @if (_supportedMlLibraries != null)
            {
                <MudText Typo="Typo.subtitle2">@L["ML libraries"]</MudText>
                <MudChipSet Filter="true" MultiSelection="true" @bind-SelectedChips="SelectedMlLibsChips">
                    @if (_supportedMlLibraries != null)
                    {
                        @foreach (var lib in _supportedMlLibraries.MlLibraries)
                        {
                            <MudChip Value="@lib.ID" Text="@(lib.Properties.ContainsKey("skos:prefLabel") ? lib.Properties["skos:prefLabel"] : "")" Default="true" Variant="Variant.Text" Color="Color.Secondary" />
                        }
                    }
                </MudChipSet>
            }
            else
            {
                <DataLoaderSpinner />
            }
            @if (_compatibleAutoMls != null)
            {
                <MudText Typo="Typo.subtitle2" Class="mt-4">@L["AutoML solutions"]</MudText>
                <MudChipSet SelectedChipsChanged="OnAutoMlSolutionSelectionChanged" Filter="true" MultiSelection="true" >
                    @if (_compatibleAutoMls != null)
                    {
                        @foreach (var lib in _compatibleAutoMls.AutoMlSolutions)
                        {
                            <MudChip Value="@lib.ID" Text="@(lib.Properties.ContainsKey("skos:prefLabel") ? lib.Properties["skos:prefLabel"] : "")" Default="true" Variant="Variant.Text" Color="Color.Secondary" />
                        }
                    }
                </MudChipSet>
            }
            else
            {
                <DataLoaderSpinner />
            }
            @if (_availableStrategies != null)
            {
                <MudText Typo="Typo.subtitle2" Class="mt-4">@L["Enabled strategies"]</MudText>
                <MudChipSet
                    SelectedChipsChanged="OnStrategySelectionChanged"
                    Filter="true"
                    MultiSelection="true"
                >
                    @if (_availableStrategies != null)
                    {
                        @foreach (var strategy in _availableStrategies.Strategies)
                        {
                            <MudTooltip Text="@strategy.Description" Delay="600" Arrow="true" Placement="Placement.Bottom" Class="strategy-description-tooltip">
                                <MudChip
                                    Value="@strategy.Id"
                                    Text="@strategy.Title"
                                    Default="true"
                                    Variant="Variant.Text"
                                    Color="Color.Secondary"
                                />
                            </MudTooltip>
                        }
                    }
                </MudChipSet>
            }
            else
            {
                <DataLoaderSpinner />
            }
        </MudExpansionPanel>
    </MudExpansionPanels>

</MudStack>

@code {
    [Parameter]
    public GetDatasetResponseDto Dataset { get; set; }

    [Parameter]
    public CreateTrainingRequestDto StartAutoMlRequest { get; set; }

    [Parameter]
    public EventCallback<CreateTrainingRequestDto> StartAutoMlRequestChanged { get; set; }

    async Task UpdateStartAutoMlRequest()
    {
        await StartAutoMlRequestChanged.InvokeAsync(StartAutoMlRequest);
    }

    private GetTasksForDatasetTypeResponseDto _compatibletasks;
    private GetMlLibrariesForTaskResponseDto _supportedMlLibraries;
    private GetAutoMlSolutionsForConfigurationResponseDto _compatibleAutoMls;
    private GetAvailableStrategiesResponseDto _availableStrategies;
    private List<String> _columnNames;
    private bool IsLibPolled = false;

    public MudChip[] SelectedMlLibsChips 
    { 
        get
        {
            return _selectedMlLibChips;
        } 
        set
        {
            _selectedMlLibChips = value;
            if (_selectedMlLibChips != null)
            {
                OnMlLibrarySelectionChanged(SelectedMlLibsChips);
            }
        }
    }
    private MudChip[] _selectedMlLibChips;

    public IEnumerable<string> SelectedTargets
    {
        get
        {
            return _selectedTargets;
        }
        set
        {
            _selectedTargets = value;
            OnTargetChanged((HashSet<string>)_selectedTargets);
        }
    }

    private IEnumerable<string> _selectedTargets;

    protected async override void OnInitialized()
    {
        base.OnInitialized();
        SetupStartAutoMLConfiguration();
        await LoadData();
    }

    private async void OnRuntimeValueChanged(int e)
    {
        StartAutoMlRequest.Configuration.RuntimeLimit = e;

        await OnMlLibrarySelectionChanged();
    }

    private async void SetupStartAutoMLConfiguration()
    {
        _columnNames = new List<string>();

        if ((Dataset.Dataset.Type.ID == ":tabular") || (Dataset.Dataset.Type.ID == ":text") || (Dataset.Dataset.Type.ID == ":time_series") || (Dataset.Dataset.Type.ID == ":time_series_longitudinal"))
        {
            List<string> targets = new List<string>();
            foreach (KeyValuePair<string, ColumnSchemaDto> pair in StartAutoMlRequest.Schema)
            {
                if (string.IsNullOrEmpty(pair.Value.RoleSelected.ID) || (pair.Value.RoleSelected.ID != ":ignore") && (pair.Value.RoleSelected.ID != ":index"))
                {
                    _columnNames.Add(pair.Key);
                }
                if (pair.Value.RoleSelected.ID == ":target")
                {
                    targets.Add(pair.Key);
                }
            }
            SelectedTargets = new HashSet<string>(targets);
        }
        StartAutoMlRequest.Configuration.RuntimeLimit = 3;
        StartAutoMlRequest.Configuration.Metric = ":accuracy";
        await UpdateStartAutoMlRequest();
    }

    private async Task LoadData()
    {
        try
        {
            GetTasksForDatasetTypeRequestDto taskRequest = new GetTasksForDatasetTypeRequestDto { DatasetType = Dataset.Dataset.Type.ID };
            ApiResponseDto apiResponse = await apiClient.GetTasksForDatasetType(taskRequest);

            if (apiResponse.IsSuccessStatusCode)
            {
                _compatibletasks = Newtonsoft.Json.JsonConvert.DeserializeObject<GetTasksForDatasetTypeResponseDto>(apiResponse.Result.ToString());
                StateHasChanged();
                viewNotifier.Show(apiResponse.Message, ViewNotifierType.Success, L["Operation Successful"]);
            }
            else
            {
                viewNotifier.Show(apiResponse.Message + " : " + apiResponse.StatusCode, ViewNotifierType.Error, L["Operation Failed"]);
            }
        }
        catch (Exception ex)
        {
            viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
        }
    }

    private async void OnMlTaskSelectionChanged(string task)
    {
        if (string.IsNullOrEmpty(task))
        {
            return;
        }
        StartAutoMlRequest.Configuration.Task = task;
        try
        {
            Dictionary<string, string> dictionary = new Dictionary<string, string>();
            dictionary.Add("task", StartAutoMlRequest.Configuration.Task);
            await UpdateStartAutoMlRequest();
            /** Configuration = dictionary is currently dummy */
            //GetCompatibleAutoMlSolutionsRequestDto compatibleAutoMlRequest = new GetCompatibleAutoMlSolutionsRequestDto { Configuration = dictionary };

            //ApiResponseDto apiResponse = await apiClient.GetCompatibleAutoMlSolutions(compatibleAutoMlRequest);

            //if (apiResponse.IsSuccessStatusCode)
            //{
            //    _compatibleAutoMls = Newtonsoft.Json.JsonConvert.DeserializeObject<GetCompatibleAutoMlSolutionsResponseDto>(apiResponse.Result.ToString());
            //    StateHasChanged();
            //    viewNotifier.Show(apiResponse.Message, ViewNotifierType.Success, L["AutoMlSolution Operation Successful"]);
            //}
            //else
            //{
            //    viewNotifier.Show(apiResponse.Message + " : " + apiResponse.StatusCode, ViewNotifierType.Error, L["AutoMlSolution Operation Failed"]);
            //}

            GetMlLibrariesForTaskRequestDto supportedMlLibrariesRequest = new GetMlLibrariesForTaskRequestDto { Task = StartAutoMlRequest.Configuration.Task };
            ApiResponseDto apiResponse = await apiClient.GetMlLibrariesForTask(supportedMlLibrariesRequest);

            HandleApiResponseWrapper(apiResponse, () =>
                 _mlLibsViewModel.SetAvailableChips(
                    apiResponse.Result.MlLibraries
                        .Select(ConvertObjectInfoToChip)),
            errorMessageKey: "SupportedMlLibraries Operation Failed");
        }
        catch (Exception ex)
        {
            viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
        }
    }

    private async void OnMlLibrarySelectionChanged(MudChip[] libs)
    {
        if (IsLibPolled == false)
        {
            return;
        }
        try
        {
            Dictionary<string, string> dictionary = new Dictionary<string, string>();
            dictionary.Add("task", StartAutoMlRequest.Configuration.Task);
            List<string> libraries = new List<string>();



            StartAutoMlRequest.Configuration.SelecctedMlLibraries = new List<string>();
            foreach (var chip in libs)
            {
                { "task", StartAutoMlRequest.Configuration.Task },
                { "runtimeLimit", StartAutoMlRequest.Configuration.RuntimeLimit.ToString() }
            };





            await UpdateStartAutoMlRequest();
            if (libraries.Count != 0)
            {
                dictionary.Add("library", JsonConvert.SerializeObject(libraries));
            }
            GetAutoMlSolutionsForConfigurationRequestDto compatibleAutoMlRequest = new GetAutoMlSolutionsForConfigurationRequestDto { Configuration = dictionary };
            ApiResponseDto apiResponse = await apiClient.GetAutoMlSolutionsForConfiguration(compatibleAutoMlRequest);

            HandleApiResponseWrapper(apiResponse, () =>
                _autoMlSolutionsViewModel.SetAvailableChips(apiResponse.Result.AutoMlSolutions.Select(ConvertObjectInfoToChip))
            );

            await UpdateAvailableStrategies(dictionary);
        }
        catch (Exception ex)
        {
            viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
        }
    }

    private async Task UpdateAvailableStrategies(Dictionary<string, string> dictionary)
    {
        int runtime_limit = StartAutoMlRequest.Configuration.RuntimeLimit;
        GetAvailableStrategiesRequestDto availableStrategiesRequest = new GetAvailableStrategiesRequestDto { Configuration = dictionary, DatasetId = Dataset.Dataset.Id };
        var availableStrategiesResponse = await apiClient.GetAvailableStrategies(availableStrategiesRequest);

        HandleApiResponseWrapper(availableStrategiesResponse, () =>
            _strategiesViewModel.SetAvailableChips(availableStrategiesResponse.Result.Strategies.Select(s => (s.Id, s.Title, s.Description)))
        );
    }

    private void HandleApiResponseWrapper<T>(ApiResponseDto<T> apiResponse, Action successAction, string errorMessageKey = "Operation Failed", string successMessageKey = "Operation Successful")
    {
        StartAutoMlRequest.Configuration.SelectedAutoMlSolutions = new List<string>();
        foreach (var chip in automls)
        {
            StartAutoMlRequest.Configuration.SelectedAutoMlSolutions.Add(chip.Value.ToString());
        }
        await UpdateStartAutoMlRequest();
    }

    private async void OnStrategySelectionChanged(MudChip[] strategies)
    {
        StartAutoMlRequest.Configuration.EnabledStrategies = new List<string>();
        foreach (var chip in strategies)
        {
            StartAutoMlRequest.Configuration.EnabledStrategies.Add(chip.Value.ToString());
        }
        await UpdateStartAutoMlRequest();
    }

    private Task OnStrategySelectionChanged()
    {
        StartAutoMlRequest.Configuration.EnabledStrategies = _strategiesViewModel.SelectedIds.ToList();
        return UpdateStartAutoMlRequest();
    }

    private async void OnTargetChanged(HashSet<string> values)
    {
        //We need to update the schema configuration with appropriated target values
        foreach (var item in StartAutoMlRequest.Schema)
        {
            if (values.Contains(item.Key))
            {
                item.Value.RoleSelected.ID = ":target";
            }
            else
            {
                if ((!string.IsNullOrEmpty(item.Value.RoleSelected.ID)) && (item.Value.RoleSelected.ID == ":target"))
                {
                    item.Value.RoleSelected.ID = null;
                }
            }
        }
        await UpdateStartAutoMlRequest();
    }
}

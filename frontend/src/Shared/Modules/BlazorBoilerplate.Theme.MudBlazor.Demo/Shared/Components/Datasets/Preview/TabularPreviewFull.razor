@inject IViewNotifier viewNotifier
@inject IStringLocalizer<Global> L
@inject IApiClient apiClient
@inject IDatasetPreviewWorker previewWorker
@using Deedle
@using Microsoft.Data.Analysis

@if ((_datasetFrame == null) && (_datasetReadError == false))
{
        <DataLoaderSpinner />
}
else
{
    <MudStack>
        <MudGrid>
            <MudItem xs="3" sm="3" md="3">
                <MudCheckBox @bind-Checked="@UseHeader" Label="@L["Use header"]"></MudCheckBox>
                <MudNumericField @bind-Value="@StartRow" Label="@L["Start row"]" Variant="Variant.Text" Min="1" />
            </MudItem>
            <MudItem xs="3" sm="3" md="3">
                <MudSelect T="string" Label="@L["Column seperator"]" AnchorOrigin="Origin.BottomCenter" @bind-Value="@Delimiter">
                    <MudSelectItem Value="@("comma")" >@(L["Comma \",\""])</MudSelectItem>
                    <MudSelectItem Value="@("semicolon")" >@(L["Semicolon \";\""])</MudSelectItem>
                    <MudSelectItem Value="@("space")">@(L["Space"])</MudSelectItem>
                    <MudSelectItem Value="@("tab")">@(L["Tab"])</MudSelectItem>
                </MudSelect>
                <MudSelect T="string" Label="@L["Encoding"]" AnchorOrigin="Origin.BottomCenter" @bind-Value="@DatasetEncoding">
                    <MudSelectItem Value="@("utf-8")" >@(L["UTF-8"])</MudSelectItem>
                    <MudSelectItem Value="@("latin-1")" >@(L["latin-1"])</MudSelectItem>
                    <MudSelectItem Value="@("utf-16")" >@(L["UTF-16"])</MudSelectItem>
                    <MudSelectItem Value="@("utf-32")" >@(L["UTF-32"])</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="3" sm="3" md="3">
                <MudTextField Mask="@(new RegexMask(@"^.{1,1}$"))" Label="@L["Escape character"]" @bind-Value="@EscapeCharacter"  Variant="@Variant.Text" />
                    <MudTextField Mask="@(new RegexMask(@"^.{1,1}$"))" Label="@L["Decimal character"]" @bind-Value="@DecimalCharacter" Variant="@Variant.Text" />
            </MudItem>
            <MudItem xs="3" sm="3" md="3">
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@SaveConfiguration">@L["Save"]</MudButton>
            </MudItem>
        </MudGrid>
        @if (_datasetReadError == true)
        {
            <MudText Typo="Typo.body2">@L["Could not read dataset successfully, change configuration"]</MudText>
        }
        else
        {
             <MudTable Items="@_datasetFrame.Rows" style="width:stretch" class="mat-elevation-z5" FixedHeader="true" Dense="true">
                <HeaderContent>
                    @foreach (var item in _datasetFrame.Columns)
                    {
                       
                        @if (UseHeader == true)
                        {
                            <MudTh>@item.Name</MudTh>
                        }
                        else
                        {
                            <MudTh Style="background-color: gray">@item.Name</MudTh>
                        }

                    }
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate>

                    @if (true) 
                    {
                        @foreach (var item in context)
                        {
                            @if (_index < StartRow)
                            {
                                <MudTd Style="background-color: gray"> @item </MudTd>
                            }
                            else
                            {
                                <MudTd>@item</MudTd>
                            }

                        }
                        IncreaseIndex();
                    }
   
                </RowTemplate>
            </MudTable>
        }
        
    </MudStack>
}

@code {

    public void IncreaseIndex()
    {
        _index++;
    }

    [Parameter]
    public string DatasetData
    {
        get
        {
            return _datasetData;
        }
        set
        {
            _datasetData = value;
            ReloadDataFrame();
        }
    }
    private string _datasetData;


    private DataFrame _datasetFrame;
    private int _index = 1;

    [Parameter]
    public GetDatasetResponseDto Dataset
    { 
        get
        {
            return _dataset;
        } 
        set
        {
            _dataset = value;
            ReloadDataFrame();
        } 
    }
    private GetDatasetResponseDto _dataset;

    public bool UseHeader
    { 
        get
        {
            return Dataset.Dataset.FileConfiguration["use_header"];
        } 
        set
        {
            if (value != null)
            {
                Dataset.Dataset.FileConfiguration["use_header"] = value;
                _index = 1;
            }
        } 
    }

    public int StartRow
    { 
        get
        {
            return (int)Dataset.Dataset.FileConfiguration["start_row"];
        } 
        set
        {
            if (value != null)
            {
                Dataset.Dataset.FileConfiguration["start_row"] = value;
                _index = 1;
            }
            
            
        } 
    }

    public string Delimiter
    { 
        get
        {
            return Dataset.Dataset.FileConfiguration["delimiter"];
        } 
        set
        {
            if (value != null)
            {
                Dataset.Dataset.FileConfiguration["delimiter"] = value;
                _rowIndex = 0;
                _index = 1;
                ReloadDataFrame();
            }
        } 
    }
    private string _delimiter;
    private int _rowIndex = 0;
    public string EscapeCharacter
    { 
        get
        {
            return Dataset.Dataset.FileConfiguration["escape_character"];
        } 
        set
        {
            if (value != null)
            {
                Dataset.Dataset.FileConfiguration["escape_character"] = value;
            }
        } 
    }

    public string DecimalCharacter
    { 
        get
        {
            return Dataset.Dataset.FileConfiguration["decimal_character"];
        } 
        set
        {
            if (value != null)
            {
                Dataset.Dataset.FileConfiguration["decimal_character"] = value;
            }
        } 
    }

    public string DatasetEncoding
    {
        get
        {
            return Dataset.Dataset.FileConfiguration["encoding"];
        }
        set
        {
            if (value != null)
            {
                Dataset.Dataset.FileConfiguration["encoding"] = value;
                ReloadDataFrame();
            }
        }
        
    }
    private string searchString = "";

    private bool _isSavingAllowed = true;
    private bool _datasetReadError = false;
    private void ReloadDataFrame()
    {
        try
        {
            if (DatasetData != null)
            {
                // convert string to stream
                byte[] byteArray = Encoding.ASCII.GetBytes(DatasetData);
                MemoryStream stream = new MemoryStream(byteArray);
                _datasetFrame =  DataFrame.LoadCsv(stream, separator: Dataset.Dataset.GetDelimiter(), encoding : Dataset.Dataset.GetEncoding(), numberOfRowsToRead: 50);
                _datasetFrame.FillNulls("NaN", true);
                if(_datasetFrame.Rows.Count == 0){
                    _isSavingAllowed = false;
                    _datasetReadError = true;
                } else {
                    _isSavingAllowed = true;
                    _datasetReadError = false;
                }
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _datasetReadError = true;
            _isSavingAllowed = false;
            StateHasChanged();
            viewNotifier.Show("Data canÂ´t be read using column delimiter:" + ex.Message, ViewNotifierType.Error, L["Operation Failed"]);
        }    
        
    }

    private async void SaveConfiguration()
    {
        if (_isSavingAllowed == false)
        {
            viewNotifier.Show(L["File configuration can not be saved, incompatible delimiter or encoding"], ViewNotifierType.Error, L["Operation Failed"]);
            return;
        }
        previewWorker.UpdateDatasetFileConfiguration(Dataset);
    }
}

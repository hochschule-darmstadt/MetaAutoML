
@using System 
@using System.IO
@using Microsoft.AspNetCore.Hosting
@using Microsoft.Extensions.Logging
@using System.Net.Http.Headers
@inject IApiClient apiClient
@inject IViewNotifier viewNotifier
@inject IJSRuntime JS
@inject IStringLocalizer<Global> L
@inject IHttpClientFactory ClientFactory
@inject IFileUploader fileUploader
@inject NavigationManager NavManager


<MudCard Elevation="5">
    <MudCardHeader Style="border-bottom-style: inset; border-bottom-width: 1px;">
        <CardHeaderContent >
            <MudText Typo="Typo.h6">@L["Predict online"]</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudStack Row="true" Class="align-content-center" Style="margin-top: 8px">
                <MudButton OnClick="OnOpenUpload"
                    Variant="Variant.Filled" 
                    Color="Color.Secondary"
                    EndIcon="@Icons.Filled.CloudUpload"
                           Size="Size.Small">@L["Add"]</MudButton>
            </MudStack>
        </CardHeaderActions>
    </MudCardHeader>
    <MudCardContent>
        <MudPaper Height="100px" Elevation="0">
            @if (_predictionDatasets == null)
            {
                <DataLoaderSpinner />
            }
            else
            {
                <MudTable Items="@_predictionDatasets.Datasets" style="width:stretch" class="mat-elevation-z5" AllowSelection="false" Dense="true">
                    <HeaderContent>
                        <MudTh>@L["Name"]</MudTh>
                        <MudTh>@L["Date"]</MudTh>
                        <MudTh>@L["Predict online"]</MudTh>
                        <MudTh>@L["Predict online"]</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudLink Href="@NavManager.ToAbsoluteUri("datasets/" + @context.Identifier).AbsoluteUri" Style="cursor: pointer; display: flex;"><MudIcon Size="Size.Small" Icon="@Icons.Material.Filled.ListAlt" Style="margin-right: 4px;" /> @context.Name</MudLink>
                        </MudTd>
                        <MudTd>@L[context.Type.Properties.ContainsKey("skos:prefLabel") ? context.Type.Properties["skos:prefLabel"] : ""]</MudTd>
                        <MudTd>
                            <MudButton OnClick="@(() => MakeOnlinePrediction(context))" Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small">@L["Predict online"]</MudButton>
                        </MudTd>
                        <MudTd>
                            <MudButton OnClick="@(() => DownlaodPrediction(context))" Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small">@L["Download result CSV"]</MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                @*<InputFile id="fileInput" OnChange="UploadFiles" hidden />*@
@*                @if (Model.Model.Status == "completed")
                {
                    <MudStack>
                        <MudButton HtmlTag="label"
                                   Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   StartIcon="@Icons.Filled.CloudUpload"
                                   for="fileInput">
                            @L["Upload File"]
                        </MudButton>
                        <MudButton StartIcon="@Icons.Filled.CloudDownload" Color="Color.Secondary" Disabled="@_downloadReady" OnClick="@DownloadPredictions">@L["Download result CSV"]</MudButton>
                    </MudStack>
                }
                else
                {
                    <MudStack>
                        <MudButton HtmlTag="label"
                            Disabled="true"
                           Variant="Variant.Filled"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Filled.CloudUpload">
                            @L["Upload File"]
                        </MudButton>
                        <MudButton StartIcon="@Icons.Filled.CloudDownload" Color="Color.Secondary" Disabled="true">@L["Download result CSV"]</MudButton>
                    </MudStack>
                }*@
            }
        </MudPaper>
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public GetModelResponseDto Model
    { 
        get
        {
            return _model;
        } 
        set
        {
            _model = value;
            StateHasChanged();
        } 
    }
    private GetModelResponseDto _model;
    [Parameter]
    public string DatasetIdentifier
    {
        get
        {
            return _datasetIdentifier;
        }
        set
        {
            _datasetIdentifier = value;
            if (_datasetIdentifier != null)
            {
                fileUploader.UploadPredictionDatasetRequest.DatasetIdentifier = _datasetIdentifier;
                LoadPredictionDatasets();
            }
            StateHasChanged();
        }
    }
    private string _datasetIdentifier;

    private GetPredictionsResponseDto _predictionDatasets;
    private ModelPredictResponseDto _modelPrediction;
    private bool _downloadReady = true;
    private ModelPredictResponseDto _predictionResult;


    private void OnOpenUpload()
    {
        fileUploader.IsPredictionDatasetToUpload = true;
        fileUploader.IsUploadPredictionDatasetDialogOpen = true;
        fileUploader.RefreshUploadComponentCallback();
    }
    private async Task LoadPredictionDatasets()
    {

        try
        {

            ApiResponseDto apiResponse = await apiClient.GetPredictionDatasets(new GetPredictionsRequestDto { ModelId = _datasetIdentifier });
            if (apiResponse.IsSuccessStatusCode)
            {
                _predictionDatasets = Newtonsoft.Json.JsonConvert.DeserializeObject<GetPredictionsResponseDto>(apiResponse.Result.ToString());
                StateHasChanged();
            }
            else
            {
                viewNotifier.Show(apiResponse.Message + " : " + apiResponse.StatusCode, ViewNotifierType.Error, L["Operation Failed"]);
            }
        }
        catch (Exception ex)
        {
            viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
        }
    }

    private async void MakeOnlinePrediction(PredictionDatasetDto predictionDataset)
    {
        try
        {
            ApiResponseDto apiResponse = await apiClient.ModelPrediction(new ModelPredictionRequestDto() { PredictionDatasetIdentifier = predictionDataset.Identifier, ModelIdentifier=_model.Model.Identifier });
        if (apiResponse.IsSuccessStatusCode)
            {
                _modelPrediction = Newtonsoft.Json.JsonConvert.DeserializeObject<ModelPredictResponseDto>(apiResponse.Result.ToString());
                StateHasChanged();
            }
            else
            {
                viewNotifier.Show(apiResponse.Message + " : " + apiResponse.StatusCode, ViewNotifierType.Error, L["Operation Failed"]);
            }
        }
        catch (Exception ex)
        {
            viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
        }
    }

    private async void DownlaodPrediction(PredictionDatasetDto predictionDataset)
    {
        try
        {
            ApiResponseDto apiResponse = await apiClient.GetPredictionDatasetPrediction(new DownloadPredictionRequestDto() { PredictionDatasetIdentifier = predictionDataset.Identifier, ModelIdentifier=_model.Model.Identifier, PredictionIdentifier = predictionDataset.Predictions[_model.Model.Identifier].Predictions.ElementAt(0).Key });
            if (apiResponse.IsSuccessStatusCode)
            {
                DownloadPredictionResponseDto response = Newtonsoft.Json.JsonConvert.DeserializeObject<DownloadPredictionResponseDto>(apiResponse.Result.ToString());

                var stream = new MemoryStream(response.Content);
                using var streamRef = new DotNetStreamReference(stream: stream);
                await JS.InvokeVoidAsync("downloadFileFromStream", "predictions.csv", streamRef);
                StateHasChanged();
            }
            else
            {
                viewNotifier.Show(apiResponse.Message + " : " + apiResponse.StatusCode, ViewNotifierType.Error, L["Operation Failed"]);
            }
        }
        catch (Exception ex)
        {
            viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
        }
    }

    //private async Task UploadFiles(InputFileChangeEventArgs e)
    //{
    //    //try
    //    //{
    //    //    var file = e.File;
    //    //    using var stream = e.File.OpenReadStream((512000 * 2 * 400));
    //    //    using var ms = new MemoryStream();
    //    //    await stream.CopyToAsync(ms);
    //    //    var content = ms.ToArray();


    //    //    //ApiResponseDto apiResponse = await apiClient.ModelPrediction(new ModelPredictionRequestDto { TestData = content, ModelId = Model.Model.Identifier});
    //    //    if (apiResponse.IsSuccessStatusCode)
    //    //    {
    //    //        _predictionResult = Newtonsoft.Json.JsonConvert.DeserializeObject<ModelPredictResponseDto>(apiResponse.Result.ToString());
    //    //        _downloadReady = false;
    //    //        StateHasChanged();
    //    //    }
    //    //    else
    //    //    {
    //    //        viewNotifier.Show(apiResponse.Message + " : " + apiResponse.StatusCode, ViewNotifierType.Error, L["Operation Failed"]);
    //    //    }
    //    //}
    //    //catch (Exception ex)
    //    //{
    //    //    viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
    //    //}
    //}

    //private async void DownloadPredictions()
    //{
    //    try{
    //        byte[] predictionBytes = _predictionResult.Predictions.SelectMany(s => System.Text.Encoding.UTF8.GetBytes(s + Environment.NewLine)).ToArray();
            
    //        var stream = new MemoryStream(predictionBytes);
    //        using var streamRef = new DotNetStreamReference(stream: stream);
    //        await JS.InvokeVoidAsync("downloadFileFromStream", "predictions.csv", streamRef);
    //    }
    //    catch (Exception ex)
    //    {
    //        viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
    //    }
    //}


}

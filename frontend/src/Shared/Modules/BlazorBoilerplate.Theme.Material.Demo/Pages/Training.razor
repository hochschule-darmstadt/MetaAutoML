@page "/datasets/{DatasetId}/training/{SessionId}"
@inject IStringLocalizer<Global> L
@using System
@using System.Timers
@inject IApiClient apiClient
@inject IViewNotifier viewNotifier
@inject IJSRuntime JSRuntime
@inject NavigationManager NavManager
@inject BlazorBoilerplate.Shared.Services.SessionState SessionState
@attribute [Authorize]

<MatTabGroup>
    <MatTab Label="Leaderboard">
        @if (_session!=null){
            @if (_session.Status == "busy")
            {
                <MatProgressBar Indeterminate="true"></MatProgressBar>
            }
        }
        <MatTable Items="@sortedData" PageSize="25" class="mat-elevation-z5" ShowPaging="false" UseSortHeaderRow="true">
            <MatTableHeader>
                <MatSortHeaderRow SortChanged="@SortData">
                    <MatSortHeader SortId="name">AutoML</MatSortHeader>
                    <MatSortHeader SortId="library"><span style="width:220px">ML library</span></MatSortHeader>
                    <MatSortHeader SortId="model"><span style="width:162px">Model</span></MatSortHeader>
                    <MatSortHeader SortId="testscore">Score</MatSortHeader>
                    <MatSortHeader SortId="predictiontime">Prediction time[ms]</MatSortHeader>
                    <MatSortHeader SortId="status">Status</MatSortHeader>
                    <th></th>
                </MatSortHeaderRow>
            </MatTableHeader>
            <MatTableRow>
                <td>@context.Name</td>
                <td>@context.Library</td>
                <td>
                    <a href="@NavManager.ToAbsoluteUri("datasets/" + DatasetId + "/training/" + SessionId + "/model/" + context.Name).AbsoluteUri" Style="cursor: pointer;">@context.Model</a>
                </td>
                <td>@string.Format("{0:f3}", @context.TestScore)</td>
                <td>@string.Format("{0:f3}", @context.Predictiontime)</td>
                <td>@context.Status</td>
                <td>
                    <ModelMenu OpenModel="OpenModel" HandleClick="@(() => HandleModelChanged(context))"></ModelMenu>
                </td>
            </MatTableRow>
        </MatTable>
    </MatTab>
    <MatTab Label="Configuration">
        <Configuration Session="@_session"></Configuration>
    </MatTab>
</MatTabGroup>

@code {
    [Parameter]
    public string? DatasetId { get; set; }
    [Parameter]
    public string? SessionId { get; set; }

    private GetSessionResponseDto _session = null;
    private Timer _timer;
    private String ModelName;

    public class AutoML{
        public string Name { get; set; }
        public string Library { get; set; }
        public string Model { get; set; }
        public double TestScore { get; set; }
        public double Predictiontime { get; set; }
        public string Status { get; set; }

        public AutoML(string name, string library, string model, double testScore, double predictiontime, string status){
            Name = name;
            Library = library;
            Model = model;
            TestScore = testScore;
            Predictiontime = predictiontime;
            Status = status;
        }
    }
    List<AutoML> automls = new List<AutoML>();
    AutoML[] sortedData = null;

    protected override void OnInitialized(){
        LoadSession(null, null);
        _timer = new Timer()
        {
            AutoReset = true,
            Enabled = true,
            Interval = 5000
        };
        _timer.Elapsed += LoadSession;
        Console.WriteLine("Session Timer created");
    }

    protected void OpenModel(){
        NavManager.NavigateTo(NavManager.ToAbsoluteUri("datasets/" + DatasetId + "/training/" + SessionId + "/Model/" + ModelName).AbsoluteUri);
    }

    private async void HandleModelChanged(AutoML obj)
    {
        ModelName = obj.Name;
    }

    private void PopulateTable(){
        automls = new List<AutoML>();
        foreach (AutoMLStatusDto automl in _session.AutoMls){
            string status = "";
            switch(automl.Status){
                case "unknown": status = "Unknown";
                        break;
                case "busy": status = "Running";
                        break;
                case "completed": status = "Completed";
                        break;
                case "failed": status = "Failed";
                        break;
            }
            automls.Add(new AutoML(automl.Name, automl.Library, automl.Model, automl.TestScore, automl.Predictiontime, status));
        }
        automls = automls.OrderByDescending(x => x.TestScore).ToList();
    }

    void SortData(MatSortChangedEvent sort)
    {
        sortedData = automls.OrderByDescending(x => x.TestScore).ToArray();
        if (!(sort == null || sort.Direction == MatSortDirection.None || string.IsNullOrEmpty(sort.SortId)))
        {
            Comparison<AutoML> comparison = null;
            switch (sort.SortId)
            {
                case "name":
                    comparison = (s1, s2) => string.Compare(s1.Name, s2.Name, StringComparison.InvariantCultureIgnoreCase);
                    break;
                case "library":
                    comparison = (s1, s2) => string.Compare(s1.Library, s2.Library, StringComparison.InvariantCultureIgnoreCase);
                    break;
                case "model":
                    comparison = (s1, s2) => string.Compare(s1.Model, s2.Model, StringComparison.InvariantCultureIgnoreCase);
                    break;
                case "testscore":
                    comparison = (s1, s2) => s1.TestScore.CompareTo(s2.TestScore);
                    break;
                case "predictiontime":
                    comparison = (s1, s2) => s1.Predictiontime.CompareTo(s2.Predictiontime);
                    break;
                case "status":
                    comparison = (s1, s2) => string.Compare(s1.Status, s2.Status, StringComparison.InvariantCultureIgnoreCase);
                    break;
            }
            if (comparison != null)
            {
                if (sort.Direction == MatSortDirection.Desc)
                {
                    Array.Sort(sortedData, (s1, s2) => -1 * comparison(s1, s2));
                }
                else
                {
                    Array.Sort(sortedData, comparison);
                }
            }
        }
    }

    private async void LoadSession(object sender, ElapsedEventArgs e)
    {
        await InvokeAsync(async () =>
        {
            try
            {
                ApiResponseDto apiResponse = await apiClient.GetSession(new GetSessionRequestDto { SessionId = SessionId });

                if (apiResponse.IsSuccessStatusCode)
                {
                    _session = Newtonsoft.Json.JsonConvert.DeserializeObject<GetSessionResponseDto>(apiResponse.Result.ToString());
                    if (_session.Status != "busy")
                    {
                        DisposeTimer();
                    }
                    SessionState.session = _session;
                    PopulateTable();
                    SortData(null);
                    StateHasChanged();
                }
                else
                {
                    viewNotifier.Show(apiResponse.Message + " : " + apiResponse.StatusCode, ViewNotifierType.Error, L["Operation Failed"]);
                }
            }
            catch (Exception ex)
            {
                viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
                _timer.Elapsed -= LoadSession;
            }
        });
    }

    public void DisposeTimer(){
        if(_timer!=null){
            _timer.Elapsed -= LoadSession;
            _timer?.Dispose();
            _timer = null;
            Console.WriteLine("Session Timer destroyed");
        }
    }
}